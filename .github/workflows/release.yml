name: Build and Release
on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: false
        default: 'auto'
jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Install dependencies
        run: npm ci
      - name: Check for Android folder
        run: |
          if [ ! -d "android" ]; then
            echo "? ERROR: Android folder not found!"
            echo ""
            echo "The native Android project structure is missing from your repository."
            echo ""
            echo "To fix this, run these commands locally:"
            echo "  1. setup-project.bat (on Windows) or ./setup-project.sh (on Linux/macOS)"
            echo "  2. git add ."
            echo "  3. git commit -m 'Add native Android project structure'"
            echo "  4. git push origin main"
            echo ""
            echo "The android folder must be committed to your repository for CI/CD to work."
            exit 1
          fi
          echo "? Android folder found"
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Make gradlew executable
        run: chmod +x android/gradlew
      - name: Build Android Debug APK
        run: |
          cd android
          ./gradlew assembleDebug --no-daemon --stacktrace
      - name: Build Android Release APK
        run: |
          cd android
          ./gradlew assembleRelease --no-daemon --stacktrace

      - name: List generated APK files
        run: |
          echo "ðŸ“¦ Listing generated APK files..."
          echo "Debug APKs:"
          find android/app/build/outputs/apk/debug -type f -name "*.apk" || echo "No debug APKs found"
          echo ""
          echo "Release APKs:"
          find android/app/build/outputs/apk/release -type f -name "*.apk" || echo "No release APKs found"

      - name: Get app version
        id: app_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
      - name: Determine version tag
        id: version_tag
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ] && [ "${{ github.event.inputs.version }}" != "auto" ]; then
            VERSION="v${{ github.event.inputs.version }}"
          else
            VERSION="v${{ steps.app_version.outputs.version }}-build.${{ github.run_number }}"
          fi
          echo "tag=$VERSION" >> $GITHUB_OUTPUT
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30
      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 90
          if-no-files-found: warn
      - name: Create Release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version_tag.outputs.tag }}
          name: Release ${{ steps.version_tag.outputs.tag }}
          body: |
            ## ?? Task Manager App - Build #${{ github.run_number }}
            ### ?? Release Information
            - **Version:** ${{ steps.app_version.outputs.version }}
            - **Build Number:** ${{ github.run_number }}
            - **Build Date:** ${{ steps.date.outputs.date }}
            - **Commit:** [${{ github.sha }}](${{ github.event.repository.html_url }}/commit/${{ github.sha }})
            ### ?? Changes
            ${{ github.event.head_commit.message }}
            ### ?? Installation
            #### Debug APK (Recommended for Testing)
            - Download **TaskManager-debug.apk** below
            - Enable "Install from Unknown Sources" in your device settings
            - Install and test the app
            #### Release APK (Production Build)
            - Download **TaskManager-release.apk** below
            - This is an unsigned release build
            - For production use, you should sign this APK with your keystore
            ### ?? Technical Details
            - React Native Version: 0.73.2
            - Node Version: 18
            - Java Version: 17
            ---
            *This release was automatically generated by GitHub Actions*
          draft: false
          prerelease: false
          files: |
            android/app/build/outputs/apk/debug/app-debug.apk
            android/app/build/outputs/apk/release/*.apk
          fail_on_unmatched_files: false
  # Optional: Add iOS build job if needed
  # build-ios:
  #   runs-on: macos-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #     # Add iOS build steps here
